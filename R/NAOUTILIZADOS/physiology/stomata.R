# Global Vars:

# Generico UPPER E LOWER
# a10daylightl   # 10-day average day-time PAR - lower canopy (micro-Ein m-2 s-1)
# a10daylightu   # 10-day average day-time PAR - upper canopy (micro-Ein m-2 s-1)

# Generico UPPER E LOWER
# a10scalparaml  # 10-day average day-time scaling parameter - lower canopy (dimensionless)
# a10scalparamu  # 10-day average day-time scaling parameter - upper canopy (dimensionless)

# Duplicado c3, c4 - crops e natural veg - lower upper
# agcc3          # canopy average gross photosynthesis rate - c3 crops (mol_co2 m-2 s-1)
# agcc4          # canopy average gross photosynthesis rate - c4 crops (mol_co2 m-2 s-1)
# agcl3          # canopy average gross photosynthesis rate - c3 grasses (mol_co2 m-2 s-1)
# agcl4          # canopy average gross photosynthesis rate - c4 grasses (mol_co2 m-2 s-1)
# agcls          # canopy average gross photosynthesis rate - shrubs     (mol_co2 m-2 s-1)
# agcub          # canopy average gross photosynthesis rate - broadleaf  (mol_co2 m-2 s-1)
# agcuc          # canopy average gross photosynthesis rate - conifer    (mol_co2 m-2 s-1)

# Duplicado c3, c4
# alpha3         # intrinsic quantum efficiency for C3 plants (dimensionless)    # PARAMETRO
# alpha4         # intrinsic quantum efficiency for C4 plants (dimensionless)    # PARAMETRO

# Duplicado c3, c4 - crops e natural veg - lower upper
# ancc3          # canopy average net photosynthesis rate - c3 crops (mol_co2 m-2 s-1)
# ancc4          # canopy average net photosynthesis rate - c4 crops (mol_co2 m-2 s-1)
# ancl3          # canopy average net photosynthesis rate - c3 grasses   (mol_co2 m-2 s-1)
# ancl4          # canopy average net photosynthesis rate - c4 grasses   (mol_co2 m-2 s-1)
# ancls          # canopy average net photosynthesis rate - shrubs       (mol_co2 m-2 s-1)
# ancub          # canopy average net photosynthesis rate - broadleaf    (mol_co2 m-2 s-1)
# ancuc          # canopy average net photosynthesis rate - conifer      (mol_co2 m-2 s-1)

# Duplicado c3, c4 - crops e natural veg
# beta3          # photosynthesis coupling coefficient for C3 plants (dimensionless)   # PARAMETRO
# beta4          # photosynthesis coupling coefficient for C4 plants (dimensionless)   # PARAMETRO
# betac3         # photosynthesis coupling coefficient for C3 crops                    # PARAMETRO
# betac4         # photosynthesis coupling coefficient for C4 crops                    # PARAMETRO 

# Duplicado c3, c4 - crops e natural veg - lower upper
# cic3           # intercellular co2 concentration - c3 crops (mol_co2/mol_air)
# cic4           # intercellular co2 concentration - c4 crops (mol_co2/mol_air)  
# cil3           # intercellular co2 concentration - c3 plants (mol_co2/mol_air)
# cil4           # intercellular co2 concentration - c4 plants (mol_co2/mol_air)
# cils           # intercellular co2 concentration - shrubs    (mol_co2/mol_air)
# ciub           # intercellular co2 concentration - broadleaf (mol_co2/mol_air)
# ciuc           # intercellular co2 concentration - conifer   (mol_co2/mol_air)

# Generico
# cimax          # maximum value for ci (needed for model stability)  # PARAMETRO 

# Generico
# co2conc        # co2 concentration (mol/mol)  # PARAMETRO 

# Duplicado c3, c4 - crops e natural veg - lower upper
# coefbc3        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefbc4        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefbl3        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefbl4        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefbls        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefbub        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefbuc        # 'b' coefficient for stomatal conductance relationship   # PARAMETRO 

# Duplicado c3, c4 - crops e natural veg - lower upper
# coefmc3        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefmc4        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefml3        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefml4        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefmls        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefmub        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO 
# coefmuc        # 'm' coefficient for stomatal conductance relationship   # PARAMETRO   

# croplive       # 0 crops have been planted and living : 1 crops not living

# Duplicado c3, c4 - crops e natural veg - lower upper
# csc3           # leaf boundary layer co2 concentration - c3 crops (mol_co2/mol_air)
# csc4           # leaf boundary layer co2 concentration - c4 crops (mol_co2/mol_air)
# csl3           # leaf boundary layer co2 concentration - c3 plants (mol_co2/mol_air)
# csl4           # leaf boundary layer co2 concentration - c4 plants (mol_co2/mol_air)
# csls           # leaf boundary layer co2 concentration - shrubs    (mol_co2/mol_air)
# csub           # leaf boundary layer co2 concentration - broadleaf (mol_co2/mol_air)
# csuc           # leaf boundary layer co2 concentration - conifer   (mol_co2/mol_air)

# dtime          # model timestep (seconds)
# epsilon        # small quantity to avoid zero-divides and other
# exist          # probability of existence of each plant functional type in a gridcell

# Generico UPPER E LOWER
# f1             # constant used in tempvm equations    # PARAMETRO   
# f2             # constant used in tempvm equations    # PARAMETRO   

# Generico UPPER E LOWER
# fwetl          # fraction of lower canopy stem & leaf area wetted by intercepted liquid and/or snow
# fwetu          # fraction of upper canopy leaf area wetted by intercepted liquid and/or snow

# Duplicado c3, c4 - crops e natural veg - lower upper
# gammac3        # leaf respiration coefficient
# gammac4        # leaf respiration coefficient
# gammal3        # leaf respiration coefficient
# gammal4        # leaf respiration coefficient
# gammals        # leaf respiration coefficient
# gammaub        # leaf respiration coefficient
# gammauc        # leaf respiration coefficient

# Duplicado c3, c4
# greenfracl3
# greenfracl4
# grnfraccrop    # green fraction of aboveground vegetation for crops 

# Duplicado c3, c4 - crops e natural veg - lower upper
# gsc3           # c3 crop canopy stomatal conductance (mol_co2 m-2 s-1) 
# gsc4           # c4 crop canopy stomatal conductance (mol_co2 m-2 s-1) 
# gsl3           # lower canopy stomatal conductance - c3 grasses (mol_co2 m-2 s-1)
# gsl4           # lower canopy stomatal conductance - c4 grasses (mol_co2 m-2 s-1)
# gsls           # lower canopy stomatal conductance - shrubs     (mol_co2 m-2 s-1)
# gsub           # upper canopy stomatal conductance - broadleaf  (mol_co2 m-2 s-1)
# gsuc           # upper canopy stomatal conductance - conifer    (mol_co2 m-2 s-1)

# Duplicado c3, c4 - crops e natural veg - lower upper
# gsc3min        # absolute minimum stomatal conductance
# gsc4min        # absolute minimum stomatal conductance
# gsl3min        # absolute minimum stomatal conductance
# gsl4min        # absolute minimum stomatal conductance
# gslsmin        # absolute minimum stomatal conductance
# gsubmin        # absolute minimum stomatal conductance
# gsucmin        # absolute minimum stomatal conductance


# hitemp         # high temperature threshold in tempvm equation

# kc15           # co2 kinetic parameter (mol/mol)
# ko15           # o2 kinetic parameter (mol/mol) 

# lai            # canopy single-sided leaf area index (area leaf/area veg)
# lotemp         # low temperature threshold in tempvm equation
# o2conc         # o2 concentration (mol/mol)
# psurf          # surface pressure (Pa)
# q12            # specific humidity of air at z12
# q34            # specific humidity of air at z34
# sai            # current single-sided stem area index

# Generico Upper - Lower
# scalcoefl      # term needed in lower canopy scaling
# scalcoefu      # term needed in upper canopy scaling

# sl             # air-vegetation transfer coefficients (*rhoa) for lower canopy leaves & stems (m s-1*kg m-3) (A39a Pollard & Thompson 1995)

# stressn        # stess factor applied to vmax based on leaf nitrogen content in crops (dimensionless)
# stresstl       # sum of stressl over all 6 soil layers (dimensionless)
# stresstu       # sum of stressu over all 6 soil layers (dimensionless)

# su             # air-vegetation transfer coefficients (*rhoa) for upper canopy leaves (m s-1 * kg m-3) (A39a Pollard & Thompson 1995)
# t12            # air temperature at z12 (K)
# t34            # air temperature at z34 (K)
# tau15          # co2/o2 specificity ratio at 15 degrees C (dimensionless)

# Generico Upper - Lower
# terml          # term needed in lower canopy scaling
# termu          # term needed in upper canopy scaling

# Generico c3, c4, nat veg e crops
# theta3         # photosynthesis coupling coefficient for C3 plants (dimensionless)
# theta4         # photosynthesis coupling coefficient for C4 plants (dimensionless)
# thetac3        # photosynthesis coupling coefficient for C3 crops
# thetac4        # photosynthesis coupling coefficient for C4 crops


# tl             # temperature of lower canopy leaves & stems(K)

# Generico Upper - Lower
# topparl        # total photosynthetically active raditaion absorbed by top leaves of lower canopy (W m-2)
# topparu        # total photosynthetically active raditaion absorbed by top leaves of upper canopy (W m-2)

# Duplicado c3, c4 - crops e natural veg - lower upper
# totcondc3      # 
# totcondc4
# totcondl3      # 
# totcondl4      # 
# totcondls      # 
# totcondub      # 
# totconduc      #

# tu             # temperature of upper canopy leaves (K)
# use
# vmax_pft       # nominal vmax of top leaf at 15 C (mol-co2/m**2/s) [not used]

stomata <- function (iter, time, jday) {
  
  # ---------------------------------------------------------------------
  # *  *  * upper canopy physiology calculations *  * *
  # ---------------------------------------------------------------------
    
  # only perform calculations if crops are not planted
  
  # calculate physiological parameter values which are a function of temperature
  
  rwork <- 3.47e-03 - 1 / tu
  
  tau <- tau15 * exp( - 4500 * rwork)
  kc  <- kc15 * exp( 6000 * rwork)
  ko  <- ko15 * exp( 1500 * rwork)
  
  tleaf <- tu - 273.16
  
  tempvm <- exp(3500 * rwork ) / ((1 + exp(0.40 * (  5 - tleaf))) * (1 + exp(0.40 * (tleaf - 50))))
  
  # upper canopy gamma - star values (mol / mol)
  
  gamstar <- o2conc / (2 * tau)
  
  # constrain ci values to acceptable bounds -- to help ensure numerical stability
  
  ciub <- max (1.05 * gamstar, min (cimax, ciub))
  ciuc <- max (1.05 * gamstar, min (cimax, ciuc))
  
  # calculate boundary layer parameters (mol / m**2 / s) <- su / 0.029 * 1.35
  
  gbco2u <- min (10, max (0.1, su * 25.5))
  # 
  # calculate the relative humidity in the canopy air space
  # with a minimum value of 0.30 to avoid errors in the 
  # physiological calculations
  
  esat12 <- esat (t12)
  qsat12 <- qsat (esat12, psurf)
  rh12 <- max (0.30, q12 / qsat12)
  
  # ---------------------------------------------------------------------
  # broadleaf (evergreen & deciduous) tree physiology 
  # ---------------------------------------------------------------------
  # 
  # nominal values for vmax of top leaf at 15 C (mol - co2 / m**2 / s)
  
  # tropical broadleaf trees          60 e-06 mol / m**2 / sec
  # warm - temperate broadleaf trees    40 e-06 mol / m**2 / sec
  # temperate broadleaf trees         25 e-06 mol / m**2 / sec
  # boreal broadleaf trees            25 e-06 mol / m**2 / sec
  
  
  # PFT_UPDATE: Pensar em como isso vai ficar
  #             Parece um parâmetro especifico para o tipo 1 e 3
  
  if(exist[1] > 0.5) {
    vmaxub <- vmax_pft[1]     
  } else if(exist[3] > 0.5) {
    vmaxub <- vmax_pft[3]     
  } else { 
    vmaxub <- vmax_pft[5] 
  }
  
  # vmax and dark respiration for current conditions
  
  vmax <- vmaxub * tempvm * stresstu
  rdarkub <- gammaub * vmaxub * tempvm
  
  # 'light limited' rate of photosynthesis (mol / m**2 / s)
  
  je <- topparu * 4.59e-06 * alpha3 * (ciub - gamstar) / (ciub + 2 * gamstar)
  
  # 'rubisco limited' rate of photosynthesis (mol / m**2 / s)
  
  jc <- vmax * (ciub - gamstar) / (ciub + kc * (1 + o2conc / ko))
  
  # solution to quadratic equation
  
  duma <- theta3
  dumb <- je  + jc
  dumc <- je  * jc
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  #       calculate the intermediate photosynthesis rate (mol / m**2 / s)
  
  jp <- min (dumq / duma, dumc / dumq)
  
  # 'sucrose synthesis limited' rate of photosynthesis (mol / m**2 / s)
  
  js <- vmax / 2.2
  
  # solution to quadratic equation
  
  duma <- beta3
  dumb <- jp + js
  dumc <- jp * js
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the net photosynthesis rate (mol / m**2 / s)
  
  agub <- min (dumq / duma, dumc / dumq)
  anub <- agub - rdarkub
  
  # calculate co2 concentrations and stomatal condutance values
  # using simple iterative procedure
  
  # weight results with the previous iteration's values -- this
  # improves convergence by avoiding flip - flop between diffusion
  # into and out of the stomatal cavities
  
  # calculate new value of cs using implicit scheme
  
  csub <- 0.5 * (csub + co2conc - anub / gbco2u)
  csub <- max (1.05 * gamstar, csub)
  
  # calculate new value of gs using implicit scheme
  
  gsub <- 0.5 * (gsub + (coefmub * anub * rh12 / csub + coefbub * stresstu))
  
  gsub <- max (gsubmin, coefbub * stresstu, gsub)
  
  # calculate new value of ci using implicit scheme
  ciub <- 0.5 * (ciub + csub - 1.6 * anub / gsub)
  ciub <- max (1.05 * gamstar, min (cimax, ciub))
  
  # ---------------------------------------------------------------------
  # conifer tree physiology 
  # ---------------------------------------------------------------------
  # 
  # nominal values for vmax of top leaf at 15 C (mol - co2 / m**2 / s)
  
  # temperate conifer trees           30 e-06 mol / m**2 / sec
  # boreal conifer trees              20 e-06 mol / m**2 / sec
  
  # PFT_UPDATE: Pensar em como isso vai ficar
  #             Parece um parâmetro especifico para o tipo 4
  
  if(exist[4] > 0.5) {
    vmaxuc <- vmax_pft[4]
  } else { 
    vmaxuc <- vmax_pft[6]
  }
  
  # vmax and dark respiration for current conditions
  
  vmax <- vmaxuc * tempvm * stresstu
  rdarkuc <- gammauc * vmaxuc * tempvm
  
  # 'light limited' rate of photosynthesis (mol / m**2 / s)
  
  je <- topparu * 4.59e-06 * alpha3 * (ciuc - gamstar) / (ciuc + 2 * gamstar)
  
  # 'rubisco limited' rate of photosynthesis (mol / m**2 / s)
  
  jc <- vmax * (ciuc - gamstar) / (ciuc + kc * (1 + o2conc / ko))
  
  # solution to quadratic equation 
  
  duma <- theta3
  dumb <- je  + jc
  dumc <- je  * jc
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the intermediate photosynthesis rate (mol / m**2 / s) 
  
  jp <- min (dumq / duma, dumc / dumq)
  #       
  # 'sucrose synthesis limited' rate of photosynthesis (mol / m**2 / s) 
  #       
  js <- vmax / 2.2
  # 
  # solution to quadratic equation
  
  duma <- beta3
  dumb <- jp + js
  dumc <- jp * js
  #       
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the net photosynthesis rate (mol / m**2 / s)
  
  aguc <- min (dumq / duma, dumc / dumq) 
  anuc <- aguc - rdarkuc
  
  #       if (i == 1  && anuc > 0) write( * ,*) anuc * 1e+06 
  
  # calculate co2 concentrations and stomatal condutance values
  # using simple iterative procedure
  
  # weight results with the previous iteration's values -- this
  # improves convergence by avoiding flip - flop between diffusion
  # into and out of the stomatal cavities
  
  # calculate new value of cs using implicit scheme
  
  csuc <- 0.5 * (csuc + co2conc - anuc / gbco2u)
  csuc <- max (1.05 * gamstar, csuc)
  
  # calculate new value of gs using implicit scheme
  
  gsuc <- 0.5 * (gsuc + (coefmuc * anuc * rh12 / csuc + coefbuc * stresstu))
  
  gsuc <- max (gsucmin, coefbuc * stresstu, gsuc)
  
  # calculate new value of ci using implicit scheme
  
  ciuc <- 0.5 * (ciuc + csuc - 1.6 * anuc / gsuc)
  ciuc <- max (1.05 * gamstar, min (cimax, ciuc))
  
  # ---------------------------------------------------------------------
  # upper canopy scaling
  # ---------------------------------------------------------------------
  
  # the canopy scaling algorithm assumes that the net photosynthesis
  # is proportional to absored par (apar) during the daytime. during night,
  # the respiration is scaled using a 10 - day running - average daytime canopy
  # scaling parameter.
  
  # apar(x) <- A exp( - k x) + B exp( - h x) + C exp(h x)
  # an(x) is proportional to apar(x)
  
  # therefore, an(x) <- an(0) * apar(x) / apar(0)
  # an(x) <- an(0) * (A exp( - k x) + B exp( - h x) + C exp(h x)) /  
  #                 (A + B  + C)
  
  # this equation is further simplified to
  # an(x) <- an(0) * exp ( - extpar * x)
  
  # an(0) is calculated for a sunlit leaf at the top of the canopy using
  # the full - blown plant physiology model (Farquhar / Ball&Berry, Collatz).
  # then the approximate par extinction coefficient (extpar) is calculated
  # using parameters obtained from the two - stream radiation calculation.
  
  # an,canopy avg. <- integral (an(x), from 0 to xai) / lai
  # <- an(0) * (1 - exp ( - extpar * xai )) / (extpar * lai)
  
  # the term '(1 - exp ( - extpar * xai )) / lai)' scales photosynthesis from leaf
  # to canopy level (canopy average) at day time. A 10 - day running mean of this
  # scaling parameter (weighted by light) is then used to scale the respiration
  # during night time.
  
  # once canopy average photosynthesis is calculated, then the canopy average
  # stomatal conductance is calculated using the 'big leaf approach',i.e. 
  # assuming that the canopy is a big leaf and applying the leaf - level stomatal
  # conductance equations to the whole canopy.
  
  # calculate the approximate par extinction coefficient:
  
  # extpar <- (k * A  + h  * B  - h  * C) / (A + B  + C)
  
  extpar <- (termu[6] * scalcoefu[1] + termu[7] * scalcoefu[2] - termu[7] * scalcoefu[3]) /max (scalcoefu[4], epsilon)
  
  extpar <- max (1e-1, min (1e+1, extpar))
  
  # calculate canopy average photosynthesis (per unit leaf area):
  
  pxaiu <- extpar * (lai[2] + sai[2])
  plaiu <- extpar * lai[2]
  
  # scale is the parameter that scales from leaf - level photosynthesis to
  # canopy average photosynthesis
  # CD : replaced 24 (hours) by 86400 / dtime for use with other timestep
  
  zweight <- exp( - 1 / (10 * 86400 / dtime))
  
  # for non - zero lai
  
  if(plaiu > 0) {
    
    # day - time conditions, use current scaling coefficient
    
    if(topparu > 10) {
      
      scale <- (1 - exp( - pxaiu)) / plaiu
      
      # update 10 - day running mean of scale, weighted by light levels
      
      a10scalparamu <- zweight * a10scalparamu +  
        (1 - zweight) * scale  * topparu
      
      a10daylightu <- zweight * a10daylightu +  
        (1 - zweight) * topparu
      
      # night - time conditions, use long - term day - time average scaling coefficient
      
    } else {
      
      scale <- a10scalparamu / a10daylightu
      
    }
    
    # if no lai present
    
  } else {
    
    scale <- 0
    
  }
  
  # perform scaling on all carbon fluxes from upper canopy
  
  agcub <- agub * scale
  agcuc <- aguc * scale
  
  ancub <- anub * scale
  ancuc <- anuc * scale
  
  # calculate diagnostic canopy average surface co2 concentration 
  # (big leaf approach)
  
  cscub <- max (1.05 * gamstar, co2conc - ancub / gbco2u)
  cscuc <- max (1.05 * gamstar, co2conc - ancuc / gbco2u)
  
  # calculate diagnostic canopy average stomatal conductance (big leaf approach)
  
  gscub <- coefmub * ancub * rh12 / cscub + coefbub * stresstu
  
  gscuc <- coefmuc * ancuc * rh12 / cscuc + coefbuc * stresstu
  
  gscub <- max (gsubmin, coefbub * stresstu, gscub)
  gscuc <- max (gsucmin, coefbuc * stresstu, gscuc)
  
  # calculate total canopy and boundary - layer total conductance for 
  # water vapor diffusion
  
  rwork <- 1 / su
  dump <- 1 / 0.029
  
  totcondub <- 1 / (rwork + dump / gscub)
  totconduc <- 1 / (rwork + dump / gscuc)
  
  # multiply canopy photosynthesis by wet fraction - this calculation is
  # done here and not earlier to avoid using within canopy conductance
  
  rwork <- 1 - fwetu
  
  agcub <- rwork * agcub
  agcuc <- rwork * agcuc
  
  ancub <- rwork * ancub
  ancuc <- rwork * ancuc
  
  #      }  ! crop existence
  
  # ---------------------------------------------------------------------
  # *  *  * lower canopy physiology calculations * * *
  # ---------------------------------------------------------------------
  
  # calculate physiological parameter values which are a function of temperature
  
  rwork <- 3.47e-03 - 1 / tl
  
  tau <- tau15 * exp( - 5000 * rwork)
  kc <- kc15 * exp( 6000 * rwork)
  ko <- ko15 * exp( 1400 * rwork)
  
  tleaf <- tl - 273.16
  
  tempvm <- exp(3500 * rwork ) / ((1 + exp(0.40 * (  5 - tleaf))) * (1 + exp(0.40 * (tleaf - 50))))
  
  # lower canopy gamma - star values (mol / mol)
  
  gamstar <- o2conc / (2 * tau)
  
  # constrain ci values to acceptable bounds -- to help ensure numerical stability
  
  cils <- max (1.05 * gamstar, min (cimax, cils))
  cil3 <- max (1.05 * gamstar, min (cimax, cil3))
  cil4 <- max (0           , min (cimax, cil4))
  
  # constrain ci value to acceptable bounds for crops
  
  cic3 <- max (1.05 * gamstar, min (cimax, cic3))
  cic4 <- max (0           , min (cimax, cic4))
  
  # calculate boundary layer parameters (mol / m**2 / s) <- sl / 0.029 * 1.35
  
  #sant - original -  
  gbco2l <- min (10, max (0.1, sl * 25.5))
  
  #sant - I think should be-> m.s - 1*kg / m3 <- kg / m2s to (mol / m**2 / s) <- sl * (1 / 0.029) - > (1 / M) <- (mol / kg)
  #        gbco2l <- min (10, max (0.1, sl[i] * (1 / 0.029)))
  # 
  # calculate the relative humidity in the canopy air space
  # with a minimum value of 0.30 to avoid errors in the 
  # physiological calculations
  
  esat34 <- esat (t34)
  qsat34 <- qsat (esat34, psurf)
  rh34 <- max (0.30, q34 / qsat34)
  
  # only perform calculations below if crops are not planted
  
  #      if (cropsums[i] == 0) then
  
  # ---------------------------------------------------------------------
  # shrub physiology
  # ---------------------------------------------------------------------
  # 
  # nominal values for vmax of top leaf at 15 C (mol - co2 / m**2 / s)
  
  vmaxls <- vmax_pft[9] 
  # 
  # vmax and dark respiration for current conditions
  
  vmax <- vmaxls * tempvm * stresstl
  rdarkls <- gammals * vmaxls * tempvm
  
  # 'light limited' rate of photosynthesis (mol / m**2 / s)
  
  je <- topparl * 4.59e-06 * alpha3 * (cils - gamstar) / (cils + 2 * gamstar)
  
  # 'rubisco limited' rate of photosynthesis (mol / m**2 / s)
  
  jc <- vmax * (cils - gamstar) / (cils + kc * (1 + o2conc / ko))
  
  # solution to quadratic equation
  
  duma <- theta3
  dumb <- je  + jc
  dumc <- je  * jc
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the intermediate photosynthesis rate (mol / m**2 / s)
  
  jp <- min (dumq / duma, dumc / dumq)
  #       
  # 'sucrose synthesis limited' rate of photosynthesis (mol / m**2 / s)
  #       
  js <- vmax / 2.2
  # 
  # solution to quadratic equation
  
  duma <- beta3
  dumb <- jp + js
  dumc <- jp * js
  #       
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the net photosynthesis rate (mol / m**2 / s)
  
  agls <- min (dumq / duma, dumc / dumq)
  anls <- agls - rdarkls
  
  # calculate co2 concentrations and stomatal condutance values
  # using simple iterative procedure
  
  # weight results with the previous iteration's values -- this
  # improves convergence by avoiding flip - flop between diffusion
  # into and out of the stomatal cavities
  
  # calculate new value of cs using implicit scheme
  
  csls <- 0.5 * (csls + co2conc - anls / gbco2l)
  csls <- max (1.05 * gamstar, csls)
  
  # calculate new value of gs using implicit scheme
  
  gsls <- 0.5 * (gsls + coefmls * anls * rh34 / csls + coefbls * stresstl)
  
  gsls <- max (gslsmin, coefbls * stresstl, gsls)
  
  # calculate new value of ci using implicit scheme
  
  cils <- 0.5 * (cils + csls - 1.6 * anls / gsls)
  cils <- max (1.05 * gamstar, min (cimax, cils))
  
  # ---------------------------------------------------------------------
  # c3 grass physiology
  # ---------------------------------------------------------------------
  # 
  # nominal values for vmax of top leaf at 15 C (mol - co2 / m**2 / s)
  
  vmaxl3 <- vmax_pft[12]
  # 
  # vmax and dark respiration for current conditions
  
  vmax <- vmaxl3 * tempvm * stresstl
  rdarkl3 <- gammal3 * vmaxl3 * tempvm
  
  # 'light limited' rate of photosynthesis (mol / m**2 / s)
  
  je <- topparl * 4.59e-06 * alpha3 * (cil3 - gamstar) / (cil3 + 2 * gamstar)
  
  # 'rubisco limited' rate of photosynthesis (mol / m**2 / s)
  
  jc <- vmax * (cil3 - gamstar) / (cil3 + kc * (1 + o2conc / ko))
  
  # solution to quadratic equation
  
  duma <- theta3
  dumb <- je  + jc
  dumc <- je  * jc
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the intermediate photosynthesis rate (mol / m**2 / s)
  
  jp <- min (dumq / duma, dumc / dumq)
  #       
  # 'sucrose synthesis limited' rate of photosynthesis (mol / m**2 / s)
  #       
  js <- vmax / 2.2
  # 
  # solution to quadratic equation
  
  duma <- beta3
  dumb <- jp + js
  dumc <- jp * js
  #       
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the net photosynthesis rate (mol / m**2 / s)
  
  agl3 <- min (dumq / duma, dumc / dumq)
  anl3 <- agl3 - rdarkl3
  
  # calculate co2 concentrations and stomatal condutance values
  # using simple iterative procedure
  
  # weight results with the previous iteration's values -- this
  # improves convergence by avoiding flip - flop between diffusion
  # into and out of the stomatal cavities
  
  # calculate new value of cs using implicit scheme
  
  csl3 <- 0.5 * (csl3 + co2conc - anl3 / gbco2l)
  csl3 <- max (1.05 * gamstar, csl3)
  
  # calculate new value of gs using implicit scheme
  
  gsl3 <- 0.5 * (gsl3 + coefml3 * anl3 * rh34 / csl3 + coefbl3 * stresstl)
  
  gsl3 <- max (gsl3min, coefbl3 * stresstl, gsl3)
  
  # calculate new value of ci using implicit scheme
  
  cil3 <- 0.5 * (cil3 + csl3 - 1.6 * anl3 / gsl3)
  cil3 <- max (1.05 * gamstar, min (cimax, cil3))
  
  # ---------------------------------------------------------------------
  # c4 grass physiology
  # ---------------------------------------------------------------------
  
  # nominal values for vmax of top leaf at 15 C (mol - co2 / m**2 / s)
  
  vmaxl4 <- vmax_pft[11]
  
  # calculate the parameter values which are a function of temperature
  
  rwork <- 3.47e-03 - 1 / tl
  
  tleaf <- tl - 273.16
  
  tempvm <- exp(3500 * rwork ) /((1 + exp(0.40 * ( 10 - tleaf))) *(1 + exp(0.40 * (tleaf - 50))))
  
  # vmax and dark respiration for current conditions
  
  vmax <- vmaxl4 * tempvm * stresstl
  rdarkl4 <- gammal4 * vmaxl4 * tempvm
  
  # initial c4 co2 efficiency (mol / m**2 / s)
  
  kco2 <- 18e+03 * vmax
  
  # 'light limited' rate of photosynthesis (mol / m**2 / s)
  
  je <- topparl * 4.59e-06 * alpha4
  
  # 'rubisco limited' rate of photosynthesis
  
  jc <- vmax
  
  # solve for intermediate photosynthesis rate
  
  duma <- theta4
  dumb <- je  + jc
  dumc <- je  * jc
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  jp <- min (dumq / duma, dumc / dumq)
  
  # 'carbon dioxide limited' rate of photosynthesis (mol / m**2 / s)
  
  ji <- kco2 * cil4
  
  # solution to quadratic equation
  
  duma <- beta4
  dumb <- jp + ji
  dumc <- jp * ji
  
  dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
  dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
  
  # calculate the net photosynthesis rate (mol / m**2 / s)
  
  agl4 <- min (dumq / duma, dumc / dumq)
  anl4 <- agl4 - rdarkl4
  
  # calculate co2 concentrations and stomatal condutance values
  # using simple iterative procedure
  
  # weight results with the previous iteration's values -- this
  # improves convergence by avoiding flip - flop between diffusion
  # into and out of the stomatal cavities
  
  # calculate new value of cs using implicit scheme
  # CD: For numerical stability (to avoid division by zero in gsl4), 
  # csl4 is limited to 1e-8 mol_co2 / mol_air.
  #  
  csl4 <- 0.5 * (csl4 + co2conc - anl4 / gbco2l)
  csl4 <- max (1e-8, csl4)
  
  # calculate new value of gs using implicit scheme
  
  gsl4 <- 0.5 * (gsl4 + coefml4 * anl4 * rh34 / csl4 + coefbl4 * stresstl)
  
  gsl4 <- max (gsl4min, coefbl4 * stresstl, gsl4)
  
  # calculate new value of ci using implicit scheme
  
  cil4 <- 0.5 * (cil4 + csl4 - 1.6 * anl4 / gsl4)
  cil4 <- max (0, min (cimax, cil4))
  
  #      } ! crop existence
  
  # --------------------------------------------------------------------
  # identify crops that are planted 
  # ---------------------------------------------------------------------
  
  # temperature response curve constants which vary
  
  #       f1[13] <- 0.40
  #       f1[14] <- 0.40
  #       f1[15] <- 0.40
  #       f2[13] <- 0.40
  #       f2[14] <- 0.40
  #       f2[15] <- 0.40
  
  # hi and low temperature thresholds (C)
  #  
  #       lotemp[13] <- 5
  #       lotemp[14] <- 6
  #       lotemp[15] <- 0 
  
  #       hitemp[13] <- 40
  #       hitemp[14] <- 50
  #       hitemp[15] <- 38
  
  # vmax values 15 C base
  
  #       vmax_pft[13] <- 65e-06  # soybean vmax  Wullschleger, 1993
  #       vmax_pft[14] <- 70e-06  # maize vmax
  #       vmax_pft[15] <- 60e-06  # wheat vmax    Wullschleger, 1993 
  
  # drought sensitivity - to account for differences between
  # soybeans and other cereal crops (e.g., maize, wheat)
  
  #       drought[13] <- 1.25
  #       drought[14] <- 1
  #       drought[15] <- 1
  #
  
   
  
  # PFT_UPDATE: Culturas agrícolas 
  #             Tornar específico para cada tipo  
  #             Tudo que tem pra cima é de vegetações naturais e portanto, caso esteja ativo uma cultura agrícola não precisa calcular
  
  idc <- 0
  for(j in scpft:ecpft) { 
    
    # get index for current cropping practice  - could have more than
    # one crop existing in grid cell during the year for multiple
    # cropping - but only one would be in live vegetation stage 
    if(exist[j] == 1 && croplive[j] > 0) {
      idc <- j 
    }
  } 
  
  # --------------------------------------------------------------------
  # c3 crops physiology (soybean, wheat)
  # ---------------------------------------------------------------------
  # to do, Jair e Santiago, tipicar a cultura independente do "j"
  if(idc == 13 || idc == 15 || idc == 17 || idc == 18) {  # soybean or wheat  
    
    rwork <- 3.47e-03 - 1 / tl
    
    tleaf <- tl - 273.16
    
    q10 <- 2
    
    # vmax and dark respiration for current conditions
    
    #         tempvm <- exp(3500 * rwork ) /
    # > ((1 + exp(0.40 * (  lotemp[idc] - tleaf))) *  
    # > (1 + exp(0.40 * (tleaf - hitemp[idc]))))
    
    # Collatz approach
    tempvm <- q10 ** ((tleaf - 15) / 10) / ((1 + exp(f1[idc] * (lotemp[idc] - tleaf))) * (1 + exp(f2[idc] * (tleaf - hitemp[idc]))))
    
    # adjust drystress factor imposed on soybeans - on a scale of
    # 0 (less) - 1 (more), these have a 0.8 rating compared to 0.65 for maize 
    # and for wheat
    # from Penning de Vries, "Simulation of ecophysiological processes of
    # growth in several annual crops"
    
    # make average stress factor 25% higher to account for difference 
    
    #       stressc3c <- min(1, stresstl[i] * drought[idc])
    #       NEW CJK 9 - 24 - 04
    
    #	stressc3c <- min(1, drought[idc])
    stressc3c <- 1
    vmax <- max(0, vmax_pft[idc] * tempvm * min(stressc3c, stressn[idc], croplive[idc]))
    #       vmax <- max(0, vmax_pft[idc] * tempvm *  
    # > min(stressc3c, croplive[i,idc]))
    #       vmax <- max(0, vmax_pft[idc] * tempvm * croplive[i,idc])
    #       vmax <- max(0, vmax_pft[idc] * tempvm * stressc3c * croplive[i,idc])
    rdarkc3 <- gammac3 * vmax_pft[idc] * tempvm * croplive[idc]
    
    # 'light limited' rate of photosynthesis (mol / m**2 / s)
    
    je <- topparl * 4.59e-06 * alpha3 * (cic3 - gamstar) /(cic3 + 2 * gamstar)
    
    # 'rubisco limited' rate of photosynthesis (mol / m**2 / s)
    
    jc <- vmax * (cic3 - gamstar) / (cic3 + kc * (1 + o2conc / ko))
    
    duma <- thetac3
    dumb <- je  + jc
    dumc <- je  * jc
    
    dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
    dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
    
    # calculate the intermediate photosynthesis rate (mol / m**2 / s)
    
    jp <- min (dumq / duma, dumc / dumq)
    #       
    # 'sucrose synthesis limited' rate of photosynthesis (mol / m**2 / s)
    #       
    js <- vmax / 2.2
    # 
    # solution to quadratic equation
    
    duma <- betac3
    dumb <- jp + js
    dumc <- jp * js
    #       
    dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
    dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
    
    # calculate the net photosynthesis rate (mol / m**2 / s)
    
    agc3 <- min (dumq / duma, dumc / dumq)
    anc3 <- agc3 - rdarkc3
    
    # apply stress functions to net photosynthesis rate
    
    anc3 <- anc3 * stresstl  # CJK 6 / 20 / 2004  
    #        if (i == 4) write(23,30) je*1e+06, vmax * 1e+06, jc * 1e+06, anc3 * 1e+06, tleaf
    #30      format(5f8.2) 
    
    # calculate co2 concentrations and stomatal condutance values
    # using simple iterative procedure
    
    # weight results with the previous iteration's values -- this
    # improves convergence by avoiding flip - flop between diffusion
    # into and out of the stomatal cavities
    
    # calculate new value of cs using implicit scheme
    
    csc3 <- 0.5 * (csc3 + co2conc - anc3 / gbco2l)
    csc3 <- max (1.05 * gamstar, csc3)
    
    # calculate new value of gs using implicit scheme
    
    gsc3 <- 0.5 * (gsc3 + coefmc3 * anc3 * rh34 / csc3 + coefbc3 * stressc3c)
    
    gsc3 <- max (gsc3min, coefbc3 * stressc3c, gsc3)
    
    # calculate new value of ci using implicit scheme
    
    cic3 <- 0.5 * (cic3 + csc3 - 1.6 * anc3 / gsc3)
    cic3 <- max (1.05 * gamstar, min (cimax, cic3))
    
  } else {
    
    agc3 <- 0
    anc3 <- 0     
    csc3 <- 0
    gsc3 <- 0
    cic3 <- 0
    
  }  # c3 crops
  
  
  # ---------------------------------------------------------------------
  # c4 crop physiology (corn and sugarnace)
  
  # modified by CJK to follow Collatz et al. (1992) parameterizations
  # that were based on corn data in the field
  # ---------------------------------------------------------------------
  
  if(idc == 14 || idc == 16 ) {   # maize or sugarcane    
    
    # calculate the parameter values which are a function of temperature
    
    # - original Maize         q10 <- 2
    q10 <- 2.5
    rwork <- 3.47e-03 - 1 / tl
    tleaf <- tl - 273.16
    
    #       tempvm <- exp(3500 * rwork ) / ! original Agro - IBIS 1 / 26 / 2006
    # Collatz approach
    tempvm <- q10 ** ((tleaf - 15) / 10) / ((1 + exp(f1[idc] * (lotemp[idc] - tleaf))) * (1 + exp(f2[idc] * (tleaf - hitemp[idc]))))
    
    # temperature effect on dark respiration - changed to 15 C base
    # 
    #         tresp <- q10 ** ((tleaf - 15) / 10) /
    # > (1 + exp(1.30 * (tleaf - 55)))  
    
    # vmax and dark respiration for current conditions
    # add nitrogen stress to c4 crops 
    
    #       stressc4c <- min(1, stresstl[i] * drought[idc])
    #       stressc4c <- min(1, drought[idc])
    stressc4c <- 1   # CJK 6 / 20 / 2004 
    #       vmax <- max(0, vmax_pft[idc] * tempvm *  
    # > min(stressc4c, croplive[i,idc]))
    
    #      if(i == 1  && iter == 3  && idc == 16) write(223, * )jday,stressn[i,idc]
    if(idc == 16) stressn[idc] <- 1  #even aplying 150Kg / ha the stress is too large ate end of season
    
    vmax <- max(0, vmax_pft[idc] * tempvm * min(stressc4c, stressn[idc], croplive[idc]))
    #       vmax <- max(0, vmax_pft[idc] * tempvm * stresstl[i] * croplive[i,idc])
    
    rdarkc4 <- gammac4 * vmax_pft[idc] * tempvm * croplive[idc]
    #       rdarkc4 <- gammac4 * vmax_pft[idc] * tempvm 
    
    # from Collatz et al. (1992) - changed to 15 C base 
    # equation 5B
    
    #sant - replace the original by the CLM3 scheme	
    #sant         tkco2 <- q10 ** ((tleaf - 15) / 10)
    # initial c4 co2 efficiency (mol / m**2 / s)
    
    #       kco2 <- 18e+03 * vmax          
    #        kco2 <- 18e+03 * tkco2 * vmax  !original
    #sant - based on clm3
    kco2 <- 4e+03 * vmax   #clm 3.5
    
    #sant - using this above eq. and coefm as 4 (original) - give the "same" result for NEE but with more AET.
    
    # 'light limited' rate of photosynthesis (mol / m**2 / s)
    
    #       je <- topparl[i] * 4.59e-06 * alpha4 ! original C4 all plants - collatz 
    je <- topparl * 4.59e-06 * 0.067 # needed to increase efficiency of corn plants 
    
    # 'rubisco limited' rate of photosynthesis
    
    jc <- vmax
    
    # solve for intermediate photosynthesis rate
    
    duma <- thetac4
    dumb <- je  + jc
    dumc <- je  * jc
    
    dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
    dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
    
    jp <- min (dumq / duma, dumc / dumq)
    
    # 'carbon dioxide limited' rate of photosynthesis (mol / m**2 / s)
    
    ji <- kco2 * cic4
    
    duma <- betac4
    dumb <- jp + ji
    dumc <- jp * ji
    
    dume <- max (dumb ** 2  - 4 * duma * dumc, 0)
    dumq <- 0.5 * (dumb + sqrt(dume)) + 1e-15
    
    # calculate the net photosynthesis rate (mol / m**2 / s)
    
    agc4 <- min (dumq / duma, dumc / dumq)
    anc4 <- agc4 - rdarkc4
    
    #	if(i == 1  && iter == 3  && time  >= 3600 * 8  && time  <= 18 * 3600) then
    #	 use[1,int(time/3600)] <- vmax * 1e+06   !,tempvm,rdarkc4 * 1e+06
    #	elseif(i == 1  && iter == 3  && time  == 19 * 3600) then
    #	write(23,134),jday,lai[i,1] * fl[i] * grnfraccrop[i,idc]
    # > ,use[1,8],use[1,9],use[1,10],use[1,11],use[1,12],use[1,13]
    # > ,use[1,14],use[1,15],use[1,16],use[1,17],use[1,18],grnfraccrop[i,idc]
    #	}
    # 134    format (i3,1x,f3.1,11(1x,f6.2),1x,f3.1)	
    
    # if(i == 1  && iter == 3  && time  == 3600 * 13) {
    #   write(23,134),jday,time/3600,lai[i,1] * fl[i] * grnfraccrop[i,idc],
    #   vmax * 1e+06,je*1e+06, ji * 1e+06, anc4 * 1e+06, tleaf,tempvm
    # }
    # 134    format (1x,i3,1x,11(1x,f6.2))	
    
    
    # apply stress functions to net photosynthesis rate
    #sant--- test remove water stress, and see that the winter low production is related with water stress!!
    
    anc4 <- anc4 * max(0, stresstl)  # CJK 6 / 20 / 2004 
    
    # calculate co2 concentrations and stomatal condutance values
    # using simple iterative procedure
    
    # weight results with the previous iteration's values -- this
    # improves convergence by avoiding flip - flop between diffusion
    # into and out of the stomatal cavities
    
    # calculate new value of cs using implicit scheme
    
    #sant - using this original equation the csc4 increase along the day, and it should actually decrease...
    #sant - should include a equation to define co2con at za, and make the transport to z12, and z34!!!
    csc4 <- 0.5 * (csc4 + co2conc - anc4 / gbco2l)
    #sant - I include this modification, but a complete set of physical eqs. should replace it.
    #         csc4[i] <- (1 / 13) * (csc4[i] * 12 + co2conc - anc4 / gbco2l)
    
    csc4 <- max (0, csc4)
    
    
    # calculate new value of gs using implicit scheme
    
    gsc4 <- 0.5 * (gsc4 + coefmc4 * anc4 * rh34 / csc4 + coefbc4 * stressc4c)
    #sant - this modification gives a better result, even though it should be discussed before implemented
    #sant - gs as function of lai[based on stomatal and hydraulic for sugarcane...pdf] 
    #	if(lai[i,1] < 1.2) then  !obs - lai[i,1] is always >= 1 (it is fractional lai)
    #        gsc4[i] <- 0.5 * (gsc4[i] + 3  * anc4 * rh34 / csc4[i] +  
    # > coefbc4 * stressc4c)
    #	} else {
    #        gsc4[i] <- 0.5 * (gsc4[i] + 2.4 * anc4 * rh34 / csc4[i] +  
    # > coefbc4 * stressc4c)
    #sant	}
    
    gsc4 <- max (gsc4min, coefbc4 * stressc4c, gsc4) 
    
    # calculate new value of ci using implicit scheme
    
    cic4 <- (1 / 3) * (cic4 * 2 + csc4 - 1.6 * anc4 / gsc4)
    cic4 <- max (0, min (cimax, cic4))
    
  } else {
    agc4 <- 0
    anc4 <- 0     
    csc4 <- 0
    gsc4 <- 0
    cic4 <- 0
    
  }    # c4 crops
  
  # ---------------------------------------------------------------------
  # lower canopy scaling
  # ---------------------------------------------------------------------
  
  # calculate the approximate extinction coefficient
  
  extpar <- (terml[6] * scalcoefl[1] + terml[7] * scalcoefl[2] - terml[7] * scalcoefl[3]) / max (scalcoefl[4], epsilon)
  
  extpar <- max (1e-1, min (1e+1, extpar))
  
  # calculate canopy average photosynthesis (per unit leaf area):
  
  pxail <- extpar * (lai[1] + sai[1])  #csant - lai[i,1] <- avglail / fl[i]
  plail <- extpar * lai[1]
  
  
  # scale is the parameter that scales from leaf - level photosynthesis to
  # canopy average photosynthesis
  # CD : replaced 24 (hours) by 86400 / dtime for use with other timestep
  
  zweight <- exp( - 1 / (10 * 86400 / dtime))
  
  # for non - zero lai
  
  if(plail > 0) {
    
    # day - time conditions, use current scaling coefficient
    
    if(topparl > 10) {
      
      scale <- (1 - exp( - pxail)) / plail  #csant - for example  - if lai <- 4, scale is +- 0.2
      
      # update 10 - day running mean of scale, weighted by light levels
      
      a10scalparaml <- zweight * a10scalparaml + (1 - zweight) * scale  * topparl
      
      a10daylightl <- zweight * a10daylightl +  (1 - zweight) * topparl
      
      # night - time conditions, use long - term day - time average scaling coefficient
      
    } else {
      
      scale <- a10scalparaml / a10daylightl
      
    }
    
    # if no lai present
    
  } else {
    
    scale <- 0
    
  }
  
  # perform scaling on all carbon fluxes from lower canopy
  
  agcls <- agls * scale
  agcl4 <- agl4 * scale
  agcl3 <- agl3 * scale
  agcc3 <- agc3 * scale
  agcc4 <- agc4 * scale
  
  ancls <- anls * scale
  ancl4 <- anl4 * scale
  ancl3 <- anl3 * scale
  ancc3 <- anc3 * scale
  ancc4 <- anc4 * scale
  
  # calculate canopy average surface co2 concentration
  # CD: For numerical stability (to avoid division by zero in gscl4),
  # cscl4 is limited to 1e-8 mol_co2 / mol_air.
  
  cscls <- max (1.05 * gamstar, co2conc - ancls / gbco2l)
  cscl3 <- max (1.05 * gamstar, co2conc - ancl3 / gbco2l)
  cscl4 <- max (1e-08       , co2conc - ancl4 / gbco2l)
  
  if(idc == 13 || idc == 15 || idc == 17 || idc == 18) {
    cscc3 <- max (1.05 * gamstar, co2conc - ancc3 / gbco2l)
    cscc4 <- 0
  } else if(idc == 14 || idc == 16) {
    cscc4 <- max (1e-08       , co2conc - ancc4 / gbco2l)
    cscc3 <- 0
  }
  
  # calculate canopy average stomatal conductance
  
  gscls <- coefmls * ancls * rh34 / cscls + coefbls * stresstl
  
  gscl3 <- coefml3 * ancl3 * rh34 / cscl3 + coefbl3 * stresstl
  
  gscl4 <- coefml4 * ancl4 * rh34 / cscl4 + coefbl4 * stresstl
  
  # c3 / c4 crop physiology
  
  if(idc == 13 || idc == 15 || idc == 17 || idc == 18) {
    gscc3 <- coefmc3 * ancc3 * rh34 / cscc3 + coefbc3 * stressc3c
    gscc4 <- 0
    
  } else if(idc == 14 || idc == 16) {
    gscc4 <- coefmc4 * ancc4 * rh34 / cscc4 + coefbc4 * stressc4c
    gscc3 <- 0  
  } else {
    gscc3 <- 0
    gscc4 <- 0
  }
  
  gscls <- max (gslsmin, coefbls * stresstl, gscls)
  gscl3 <- max (gsl3min, coefbl3 * stresstl, gscl3)
  gscl4 <- max (gsl4min, coefbl4 * stresstl, gscl4)
  
  # c3 / c4 crop physiology
  
  if(idc == 13 || idc == 15 || idc == 17 || idc == 18) {

    gscc3 <- max (gsc3min, coefbc3 * stressc3c, gscc3)
    gscc3 <- gscc3 * grnfraccrop[idc]
    gscc4 <- 0
  } else if(idc == 14 || idc == 16) {
    #sant - i include the greenfrac factor on photoss as well. IMPORTANT: after confirm, apply over C3 as well.
    ancc4 <- ancc4 * grnfraccrop[idc]
    agcc4 <- agcc4 * grnfraccrop[idc]
    
    gscc4 <- max (gsc4min, coefbc4 * stressc4c, gscc4)
    gscc4 <- gscc4 * grnfraccrop[idc]
    gscc3 <- 0
  } else {
    gscc3 <- 0
    gscc4 <- 0
  }
  
  
  
  
  # The following adjusts the above calculated values of ancl3, ancl4,
  # agcl3, agcl4, gscl3, and gscl4 according to what percentage of the
  # lower canopy is green by weighting the above calculations by greenfrac
  # terms. Only the green portion of the canopy performs photosynthesis.
  # Shrubs that have leaves have only green leaves since they are allowed
  # to drop their leaves in the fall. C3 and C4 grasses may be either green
  # or brown so they are the only terms that are adjusted.
  
  # Scale value of ancl3, ancl4, gscl3, and gscl4 according to what fraction
  # of the canopy is green
  
  ancl3 <- ancl3 * greenfracl3
  ancl4 <- ancl4 * greenfracl4
  
  agcl3 <- agcl3 * greenfracl3
  agcl4 <- agcl4 * greenfracl4
  
  gscl3 <- gscl3 * greenfracl3
  gscl4 <- gscl4 * greenfracl4
  
  # calculate canopy and boundary - layer total conductance for water vapor diffusion
  
  rwork <- 1 / sl   #csant - rb <- 1 / gb (gb is the leaf boundary - layer conduct) but sl <- gb * rhoa[m s - 1  * kg m - 3]
  dump <- 1 / 0.029   
  
  totcondls <- 1 / (rwork + dump / gscls)
  
  # Make sure that the calculation does not divide by zero if gscl3 or
  # gscl4 are equal to zero
  
  if(gscl3 > 0) {
    totcondl3 <- 1 / ( rwork + dump / gscl3 )
  } else {
    totcondl3 <- 0
  }
  
  if(gscl4 > 0) {
    totcondl4 <- 1 / ( rwork + dump / gscl4 )
  } else {
    totcondl4 <- 0
  }
  
  if(gscc3 > 0) {
    totcondc3 <- 1 / ( rwork + dump / gscc3 )
  } else {
    totcondc3 <- 0
  }
  
  if(gscc4 > 0) {
    totcondc4 <- 1 / ( rwork + dump / gscc4 )
  } else {
    totcondc4 <- 0
  }
  

  # multiply canopy photosynthesis by wet fraction -- this calculation is
  # done here and not earlier to avoid using within canopy conductance
  
  rwork <- 1 - fwetl
  
  agcls <- rwork * agcls
  agcl3 <- rwork * agcl3
  agcl4 <- rwork * agcl4
  agcc3 <- rwork * agcc3
  agcc4 <- rwork * agcc4
  
  ancls <- rwork * ancls
  ancl3 <- rwork * ancl3
  ancl4 <- rwork * ancl4
  ancc3 <- rwork * ancc3
  ancc4 <- rwork * ancc4
  
  # return to main program
  assign("ciub", ciub, envir = env)
  assign("ciuc", ciuc, envir = env)
  assign("csub", csub, envir = env)
  assign("gsub", gsub, envir = env)
  assign("csuc", csuc, envir = env)
  assign("gsuc", gsuc, envir = env)
  assign("a10scalparamu", a10scalparamu, envir = env)
  assign("a10daylightu", a10daylightu, envir = env)
  assign("agcub", agcub, envir = env)
  assign("agcuc", agcuc, envir = env)
  assign("ancub", ancub, envir = env)
  assign("ancuc", ancuc, envir = env)
  assign("totcondub", totcondub, envir = env)
  assign("totconduc", totconduc, envir = env)
  assign("cils", cils, envir = env)
  assign("cil3", cil3, envir = env)
  assign("cil4", cil4, envir = env)
  assign("cic3", cic3, envir = env)
  assign("cic4", cic4, envir = env)
  assign("csls", csls, envir = env)
  assign("gsls", gsls, envir = env)
  assign("csl3", csl3, envir = env)
  assign("gsl3", gsl3, envir = env)
  assign("csl4", csl4, envir = env)
  assign("gsl4", gsl4, envir = env)
  assign("csc3", csc3, envir = env)
  assign("gsc3", gsc3, envir = env)
  assign("stressn", stressn, envir = env)
  assign("csc4", csc4, envir = env)
  assign("gsc4", gsc4, envir = env)
  assign("a10scalparaml", a10scalparaml, envir = env)
  assign("a10daylightl", a10daylightl, envir = env)
  assign("agcls", agcls, envir = env)
  assign("agcl4", agcl4, envir = env)
  assign("agcl3", agcl3, envir = env)
  assign("agcc3", agcc3, envir = env)
  assign("agcc4", agcc4, envir = env)
  assign("ancls", ancls, envir = env)
  assign("ancl4", ancl4, envir = env)
  assign("ancl3", ancl3, envir = env)
  assign("ancc3", ancc3, envir = env)
  assign("ancc4", ancc4, envir = env)
  assign("use", use, envir = env)
  assign("totcondls", totcondls, envir = env)
  assign("totcondl3", totcondl3, envir = env)
  assign("totcondl4", totcondl4, envir = env)
  assign("totcondc3", totcondc3, envir = env)
  assign("totcondc4", totcondc4, envir = env)
  
  return()
}
